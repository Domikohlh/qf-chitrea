{
  library(fst)
  library(dplyr)
  library(stringr)
  library(crayon)
  library(tibble)
  library(ResourceSelection)
  library(caret)
  library(pROC)
  library(Metrics)
  library(ggplot2)
  library(readr)
  library(readxl)
  library(mice)
}
setwd("Path to your directory")
getwd()

data <- read_excel('../宏观因子库.xlsx')

#Select only numerical data
data_numeric <- data %>% 
  select(where(is.numeric))

#Standardise 
scaled_data <- scale(data_numeric)

#Find constant/zero variance column
nzv_cols <- nearZeroVar(scaled_data, saveMetrics = TRUE)
problem_cols <- nzv_cols[nzv_cols$zeroVar | nzv_cols$nzv, ]
cols_to_remove <- rownames(problem_cols) 
nzv_filtered_data <- scaled_data[, !(colnames(scaled_data) %in% cols_to_remove), drop = FALSE]

#Impute missing data using predictive mean matching (PPM)
colSums(is.na(nzv_filtered_data))
#Create 5 separate imputed datasets for variability in plausible values and improve accuracy
imputed_data <- mice(nzv_filtered_data, m = 5, method = "pmm")
combined_data <- complete(imputed_data, 1)

sum(is.na(combined_data))
sum(is.na(scaled_data))
    
colSums(is.nan(as.matrix(final_data)))
